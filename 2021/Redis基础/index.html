<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一些我的计算机笔记，JAVA/Python/Linux/后端/计算机基础"><title>Redis基础 | 懒人瑜恩</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + '2059a4484fb666484cf5e9fba7e20ce6';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis基础</h1><a id="logo" href="/.">懒人瑜恩</a><p class="description">sometimes code, sometimes English</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Redis基础</h1><div class="post-meta">2021-12-05<span> | </span><span class="category"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2021/Redis%E5%9F%BA%E7%A1%80/#vcomment"><span class="valine-comment-count" data-xid="/2021/Redis%E5%9F%BA%E7%A1%80/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-redis%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">1.redis安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85C%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.安装C语言的编译环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85redis"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.安装redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%89%8D%E5%8F%B0%E5%90%AF%E5%8A%A8%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.前台启动（不推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.1.4.</span> <span class="toc-text">4.后台启动（推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Springboot%E6%95%B4%E5%90%88Redis"><span class="toc-number">1.2.</span> <span class="toc-text">6.Springboot整合Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Redis%E4%BA%8B%E5%8A%A1-%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">7.Redis事务_锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E4%BA%8B%E5%8A%A1%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">7.1 事务定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Multi%EF%BC%8CExec%EF%BC%8CDiscard"><span class="toc-number">1.3.2.</span> <span class="toc-text">7.2 Multi，Exec，Discard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E4%BA%8B%E5%8A%A1%E5%86%B2%E7%AA%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">7.3 事务冲突</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-number">1.3.4.</span> <span class="toc-text">7.4 悲观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">1.3.5.</span> <span class="toc-text">7.5 乐观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-WATCH-key-key-%E2%80%A6"><span class="toc-number">1.3.6.</span> <span class="toc-text">7.6 WATCH key [key ….]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-Redis%E4%BA%8B%E5%8A%A1%E4%B8%89%E7%89%B9%E6%80%A7"><span class="toc-number">1.3.7.</span> <span class="toc-text">8 Redis事务三特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.4.</span> <span class="toc-text">8 Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-RDB%EF%BC%88Redis-DataBase%EF%BC%89"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.RDB（Redis DataBase）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fork"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">Fork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB%E6%8C%81%E4%B9%85%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">RDB持久化流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">持久化配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rdb%E7%9A%84%E5%A4%87%E4%BB%BD"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">rdb的备份</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-AOF"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">AOF持久化流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF-%E5%90%AF%E5%8A%A8-%E4%BF%AE%E5%A4%8D-%E6%81%A2%E5%A4%8D"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">AOF 启动&#x2F;修复&#x2F;恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E5%90%8C%E6%AD%A5%E9%A2%91%E7%8E%87"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">AOF同步频率</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rewrite%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">Rewrite压缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text">9 Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sentinel%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">sentinel配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E5%8E%9F%E5%88%99"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">故障恢复原则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Redis%E9%9B%86%E7%BE%A4"><span class="toc-number">1.6.</span> <span class="toc-text">10 Redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">1.6.1.</span> <span class="toc-text">配置集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E9%99%86"><span class="toc-number">1.6.2.</span> <span class="toc-text">登陆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E8%8A%82%E7%82%B9"><span class="toc-number">1.6.3.</span> <span class="toc-text">分配节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slots"><span class="toc-number">1.6.4.</span> <span class="toc-text">slots</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%BD%95%E5%85%A5%E5%80%BC"><span class="toc-number">1.6.5.</span> <span class="toc-text">集群录入值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">1.6.6.</span> <span class="toc-text">故障恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jedis"><span class="toc-number">1.6.7.</span> <span class="toc-text">Jedis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-6%E6%96%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">1.7.</span> <span class="toc-text">Redis 6新功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL"><span class="toc-number">1.7.1.</span> <span class="toc-text">ACL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.7.2.</span> <span class="toc-text">IO多线程</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><a id="more"></a>

<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>单线程 + 多路 IO 复用</p>
<h2 id="1-redis安装"><a href="#1-redis安装" class="headerlink" title="1.redis安装"></a>1.redis安装</h2><p>Centos系统</p>
<h3 id="1-安装C语言的编译环境"><a href="#1-安装C语言的编译环境" class="headerlink" title="1.安装C语言的编译环境"></a>1.安装C语言的编译环境</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>centos-release-<span class="keyword">scl </span><span class="keyword">scl-utils-build</span></span><br><span class="line"><span class="keyword">yum </span><span class="keyword">install </span>-y devtoolset<span class="number">-8</span>-toolchain</span><br><span class="line"><span class="keyword">scl </span>enable devtoolset<span class="number">-8</span> <span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">安装gcc</span></span><br><span class="line"><span class="keyword">yum </span><span class="keyword">install </span>gcc</span><br></pre></td></tr></table></figure>
<h3 id="2-安装redis"><a href="#2-安装redis" class="headerlink" title="2.安装redis"></a>2.安装redis</h3><ul>
<li><p>下载redis的tar包，解压</p>
</li>
<li><p>在redis目录中执行make命令</p>
</li>
<li><p>make install</p>
</li>
<li><p>安装目录为/usr/local/bin</p>
</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark:性能测试工具，可以在自己本子运行，看看自己本子性能如何</span><br><span class="line"></span><br><span class="line">redis-<span class="keyword">check</span>-aof：修复有问题的AOF文件</span><br><span class="line"></span><br><span class="line">redis-<span class="keyword">check</span>-dump：修复有问题的dump.rdb文件</span><br><span class="line"></span><br><span class="line">redis-sentinel：Redis集群使用</span><br><span class="line"></span><br><span class="line">redis-<span class="keyword">server</span>：Redis服务器启动命令</span><br><span class="line"></span><br><span class="line">redis-cli：客户端，操作入口</span><br></pre></td></tr></table></figure>


<h3 id="3-前台启动（不推荐）"><a href="#3-前台启动（不推荐）" class="headerlink" title="3.前台启动（不推荐）"></a>3.前台启动（不推荐）</h3><p>直接用 redis-server</p>
<p>命令行窗口不能关闭</p>
<h3 id="4-后台启动（推荐）"><a href="#4-后台启动（推荐）" class="headerlink" title="4.后台启动（推荐）"></a>4.后台启动（推荐）</h3><ol>
<li><p>先进行配置，/opt/redis/redis.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">daemonize</span> <span class="literal">no</span></span><br><span class="line">改为<span class="literal">yes</span></span><br></pre></td></tr></table></figure></li>
<li><p>后台启动redis，redis-server /opt/redis/redis.conf</p>
</li>
<li><p>```<br>[root@localhost redis]# /usr/local/bin/redis-server /opt/redis/redis.conf </p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">4</span>. ![image-<span class="number">20210615175718115</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210615175849529</span>.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-cli 可以进入redis命令行，输入ping，如果输出pong表示正常状态</span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210615175849529</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210615175718115</span>.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">### redis关闭</span></span><br><span class="line"></span><br><span class="line">redis-cli shutdown或 redis-cli 进入命令行 再shutdown</span><br><span class="line"></span><br><span class="line">多实例关闭，指定端口关闭：redis-cli -p <span class="number">6379</span> shutdown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 基本操作</span></span><br><span class="line"></span><br><span class="line">默认<span class="number">16</span>个数据库，类似数组下标从<span class="number">0</span>开始，初始**默认使用<span class="number">0</span>号库**</span><br><span class="line"></span><br><span class="line">使用命令 **select  \<span class="variable">&lt;dbid&gt;</span>**来切换数据库。如: select <span class="number">8</span> </span><br><span class="line"></span><br><span class="line">统一密码管理，所有库同样密码。</span><br><span class="line"></span><br><span class="line">**dbsize**查看当前数据库的key的数量</span><br><span class="line"></span><br><span class="line">**flushdb**清空当前库</span><br><span class="line"></span><br><span class="line">**flushall**通杀全部库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.常用五大数据结构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 键(key)</span></span><br><span class="line"></span><br><span class="line">- keys *查看当前库所有key   (匹配：keys *<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">- <span class="built_in">set</span> k1  v1 插入键值对</span><br><span class="line"></span><br><span class="line">- exists key 判断某个key是否存在</span><br><span class="line"></span><br><span class="line">- type key 查看你的key是什么类型</span><br><span class="line"></span><br><span class="line">- del key    删除指定的key数据</span><br><span class="line"></span><br><span class="line">- unlink key  根据value选择非阻塞删除(**异步删除**)</span><br><span class="line"></span><br><span class="line">​					仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</span><br><span class="line"></span><br><span class="line">- expire key <span class="number">10</span>  <span class="number">10</span>秒钟：为给定的key设置过期时间</span><br><span class="line"></span><br><span class="line">- ttl key 查看还有多少秒过期，-<span class="number">1</span>表示永不过期，-<span class="number">2</span>表示已过期</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">- select 命令切换数据库</span><br><span class="line"></span><br><span class="line">- dbsize 查看当前数据库的key的数量</span><br><span class="line"></span><br><span class="line">- flushdb 清空当前库</span><br><span class="line"></span><br><span class="line">- flushall 清空全部库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.1 字符串（string）</span></span><br><span class="line"></span><br><span class="line">String是Redis最基本的类型，也是键值对的形式。且是二进制安全的，可以包含任何数据。</span><br><span class="line"></span><br><span class="line">String中value大小最大是<span class="number">512</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用命令</span></span><br><span class="line"></span><br><span class="line">- <span class="built_in">set</span> \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span> [NX | EX | XX | PX]</span><br><span class="line"></span><br><span class="line">  NX：当前数据库中key不存在时，将K-V添加到数据库</span><br><span class="line"></span><br><span class="line">  XX：当前数据库中key存在时，将K-V添加到数据库，与NX参数互斥</span><br><span class="line"></span><br><span class="line">  EX：key的超时秒数</span><br><span class="line"></span><br><span class="line">  PX：key的超时毫秒数，与EX互斥</span><br><span class="line"></span><br><span class="line">- get \<span class="variable">&lt;key&gt;</span> 查询对应的键值</span><br><span class="line"></span><br><span class="line">- append  \<span class="variable">&lt;key&gt;</span>\<span class="variable">&lt;value&gt;</span>将给定的\<span class="variable">&lt;value&gt;</span> 追加到原值的末尾</span><br><span class="line"></span><br><span class="line">- strlen  \<span class="variable">&lt;key&gt;</span>获得值的长度</span><br><span class="line"></span><br><span class="line">- setnx  \<span class="variable">&lt;key&gt;</span>\<span class="variable">&lt;value&gt;</span>只有在 key 不存在时   设置 key 的值</span><br><span class="line"></span><br><span class="line">- incr  \<span class="variable">&lt;key&gt;</span></span><br><span class="line"></span><br><span class="line">  将 key 中储存的数字值增<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  只能对数字值操作，如果为空，新增值为<span class="number">1</span></span><br><span class="line"></span><br><span class="line">- decr  \<span class="variable">&lt;key&gt;</span></span><br><span class="line"></span><br><span class="line">  将 key 中储存的数字值减<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  只能对数字值操作，如果为空，新增值为-<span class="number">1</span></span><br><span class="line"></span><br><span class="line">- incrby / decrby  \<span class="variable">&lt;key&gt;</span> <span class="variable">&lt;步长&gt;</span>将 key 中储存的数字值增减。自定义步长。</span><br><span class="line"></span><br><span class="line">- mset  \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;key2&gt;</span> \<span class="variable">&lt;value2&gt;</span>  ..... </span><br><span class="line"></span><br><span class="line">  同时设置一个或多个 key-value对  </span><br><span class="line"></span><br><span class="line">- mget  \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;key2&gt;</span> \<span class="variable">&lt;key3&gt;</span> .....</span><br><span class="line"></span><br><span class="line">  同时获取一个或多个 value  </span><br><span class="line"></span><br><span class="line">- msetnx \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;key2&gt;</span> \<span class="variable">&lt;value2&gt;</span>  ..... </span><br><span class="line"></span><br><span class="line">  同时设置一个或多个 key-value 对，**当且仅当所有给定 key 都不存在。原子性，有一个失败则都失败**</span><br><span class="line"></span><br><span class="line">- getrange  \<span class="variable">&lt;key&gt;</span><span class="variable">&lt;起始位置&gt;</span><span class="variable">&lt;结束位置&gt;</span></span><br><span class="line"></span><br><span class="line">  获得值的范围，类似java中的substring，**前包，后包**</span><br><span class="line"></span><br><span class="line">- setrange  \<span class="variable">&lt;key&gt;</span><span class="variable">&lt;起始位置&gt;</span>\<span class="variable">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line">  用 \<span class="variable">&lt;value&gt;</span>  覆写\<span class="variable">&lt;key&gt;</span>所储存的字符串值，从<span class="variable">&lt;起始位置&gt;</span>开始(**索引从<span class="number">0</span>开始**)。包含前后</span><br><span class="line"></span><br><span class="line">- setex  \<span class="variable">&lt;key&gt;</span> <span class="variable">&lt;过期时间&gt;</span> \<span class="variable">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line">  设置键值的同时，设置过期时间，单位秒。</span><br><span class="line"></span><br><span class="line">- getset \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line">  以新换旧，设置了新值同时获得旧值。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 数据结构</span></span><br><span class="line"></span><br><span class="line">String结构类似Java里面的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配</span><br><span class="line"></span><br><span class="line">分配策略：长度小于<span class="number">1</span>M时，当字符串长度大于当前分配空间的长度，分配空间翻倍一次。</span><br><span class="line"></span><br><span class="line">​					长度大于<span class="number">1</span>M时，扩容一次只会多扩<span class="number">1</span>M的空间。最大长度<span class="number">512</span>M</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.2 列表（List）</span></span><br><span class="line"></span><br><span class="line">双向链表结构。对两端的操作性能高，通过索引下标操作中间的节点性能会较差。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用命令</span></span><br><span class="line"></span><br><span class="line">- lpush/rpush  \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;value2&gt;</span> \<span class="variable">&lt;value3&gt;</span> .... 从左边/右边插入一个或多个值。</span><br><span class="line"></span><br><span class="line">- lpop/rpop  \<span class="variable">&lt;key&gt;</span>从左边/右边吐出一个值。**值如果没有了，键就会被删除。**</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">- rpoplpush  \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;key2&gt;</span>从 \<span class="variable">&lt;key1&gt;</span>列表右边吐出一个值，插到\<span class="variable">&lt;key2&gt;</span>列表左边。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">- lrange \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;start&gt;</span> \<span class="variable">&lt;stop&gt;</span></span><br><span class="line"></span><br><span class="line">  按照索引下标获得元素(从左到右)</span><br><span class="line"></span><br><span class="line">- lrange mylist <span class="number">0</span> -<span class="number">1</span>  **<span class="number">0</span>左边第一个，-<span class="number">1</span>右边第一个，（<span class="number">0</span>  -<span class="number">1</span>表示获取所有）**</span><br><span class="line"></span><br><span class="line">- lindex \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;index&gt;</span>按照索引下标获得元素(从左到右)</span><br><span class="line"></span><br><span class="line">- llen \<span class="variable">&lt;key&gt;</span>获得列表长度 </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">- linsert \<span class="variable">&lt;key&gt;</span>  before \<span class="variable">&lt;value&gt;</span> \<span class="variable">&lt;newvalue&gt;</span>在 \<span class="variable">&lt;value&gt;</span>的后面插入\<span class="variable">&lt;newvalue&gt;</span>插入值</span><br><span class="line"></span><br><span class="line">- lrem \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;n&gt;</span> \<span class="variable">&lt;value&gt;</span>从左边删除n个value(从左到右)</span><br><span class="line"></span><br><span class="line">- lset \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;index&gt;</span> \<span class="variable">&lt;value&gt;</span>将列表key下标为index的值替换成value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 数据结构</span></span><br><span class="line"></span><br><span class="line">List的数据结构为快速链表 <span class="keyword">quick</span>List</span><br><span class="line"></span><br><span class="line">​	列表元素较少时，会采用一块**连续的内存存储**，结构为 ziplist，压缩列表。所有元素紧挨在一起存储，分配的是一块连续的内存。</span><br><span class="line"></span><br><span class="line">​	Redis将 链表 和 ziplist 结合起来组成 quicklist。也就是多个ziplist 使用双向指针。形成双向链表。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.3 集合（set）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> 对外提供的功能与list类似。特殊在于可以**自动排重**的。<span class="built_in">set</span>提供了判断某个成员是否在一个<span class="built_in">set</span>集合内的重要接口。</span><br><span class="line"></span><br><span class="line">Set是string类型的**无序集合。底层是一个value为null的hash表**，所以添加，删除，查找的复杂度都是o(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用命令</span></span><br><span class="line"></span><br><span class="line">- sadd \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span> \<span class="variable">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line">  将一个或多个member元素加入到集合 key 中，已经存在的member元素将被忽略</span><br><span class="line"></span><br><span class="line">- smembers \<span class="variable">&lt;key&gt;</span>取出该集合的所有值。</span><br><span class="line"></span><br><span class="line">- sismember \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span>判断集合 \<span class="variable">&lt;key&gt;</span>是否为含有该 \<span class="variable">&lt;value&gt;</span>值，有<span class="number">1</span>，没有<span class="number">0</span></span><br><span class="line"></span><br><span class="line">- scard \<span class="variable">&lt;key&gt;</span>返回该集合的元素个数。</span><br><span class="line"></span><br><span class="line">- srem \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;value2&gt;</span> .... 删除集合中的某个元素。</span><br><span class="line"></span><br><span class="line">- spop \<span class="variable">&lt;key&gt;</span>**随机从该集合中吐出一个值。**</span><br><span class="line"></span><br><span class="line">- srandmember \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;n&gt;</span>随机从该集合中取出n个值。不会从集合中删除 。</span><br><span class="line"></span><br><span class="line">- smove \<span class="variable">&lt;source&gt;</span> \<span class="variable">&lt;destination&gt;</span> value把集合中一个值从一个集合移动到另一个集合</span><br><span class="line"></span><br><span class="line">- sinter \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;key2&gt;</span>返回两个集合的**交集**元素。</span><br><span class="line"></span><br><span class="line">- sunion  \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;key2&gt;</span>返回两个集合的**并集**元素。</span><br><span class="line"></span><br><span class="line">- sdiff \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;key2&gt;</span>返回两个集合的**差集**元素(key1中的，不包含key2中的)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 数据结构</span></span><br><span class="line"></span><br><span class="line">Set 数据结构是dict字典，字典是用哈希表实现的</span><br><span class="line"></span><br><span class="line">Java中HashSet的内部实现使用的是 HashMap，只不过所有的value都指向同一个对象。</span><br><span class="line"></span><br><span class="line">Redis的<span class="built_in">set</span>结构，内部使用hash结构，所有value都指向同一个内部值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.4 哈希（Hash）</span></span><br><span class="line"></span><br><span class="line">Redis hash是一个键值对集合。是一个String类型的 **field 和 value**的映射表，hash 特别适合用于存储对象。</span><br><span class="line"></span><br><span class="line">类似Java中的 map<span class="variable">&lt;String,Object&gt;</span></span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210616110003546</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210616110003546</span>.png)</span><br><span class="line"></span><br><span class="line">通过 **key+field** 就可以操作对应属性数据。不需要重复存储数据，也不会带来序列化和并发修改控制的问题。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用命令</span></span><br><span class="line"></span><br><span class="line">- hset \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;field&gt;</span> \<span class="variable">&lt;value&gt;</span>给 \<span class="variable">&lt;key&gt;</span>集合中的  \<span class="variable">&lt;field&gt;</span>键赋值 \<span class="variable">&lt;value&gt;</span></span><br><span class="line"></span><br><span class="line">- hget \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;field&gt;</span>从\<span class="variable">&lt;key1&gt;</span>集合\<span class="variable">&lt;field&gt;</span>取出 value </span><br><span class="line"></span><br><span class="line">- hmset \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;field1&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;field2&gt;</span> \<span class="variable">&lt;value2&gt;</span>... 批量设置hash的值</span><br><span class="line"></span><br><span class="line">- hexists \<span class="variable">&lt;key1&gt;</span> \<span class="variable">&lt;field&gt;</span>查看哈希表 key 中，给定域 field 是否存在。 </span><br><span class="line"></span><br><span class="line">- hkeys \<span class="variable">&lt;key&gt;</span>列出该hash集合的所有field</span><br><span class="line"></span><br><span class="line">- hvals \<span class="variable">&lt;key&gt;</span>列出该hash集合的所有value</span><br><span class="line"></span><br><span class="line">- hincrby \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;field&gt;</span> \<span class="variable">&lt;increment&gt;</span>为哈希表 key 中的域 field 的值加上增量 <span class="number">1</span>  -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">- hsetnx \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;field&gt;</span> \<span class="variable">&lt;value&gt;</span>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 数据结构</span></span><br><span class="line"></span><br><span class="line">Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.5 有序集合(Zset)</span></span><br><span class="line"></span><br><span class="line">有序集合与普通集合 <span class="built_in">set</span> 类似，是**没有重复元素**的字符串集合</span><br><span class="line"></span><br><span class="line">不同之处在于，有序集合每个成员都关联了一个  评分（score），这个评分被用来按照从最低分到最高分的方式来排序集合中的成员。**集合的成员是唯一的，但是评分可以是重复的**</span><br><span class="line"></span><br><span class="line">&gt; 因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 常用命令</span></span><br><span class="line"></span><br><span class="line">- zadd  \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;score1&gt;</span> \<span class="variable">&lt;value1&gt;</span> \<span class="variable">&lt;score2&gt;</span> \<span class="variable">&lt;value2&gt;</span>…</span><br><span class="line"></span><br><span class="line">  将一个或多个 member 元素及其 score 值加入到有序集 key 当中。</span><br><span class="line"></span><br><span class="line">- **zrange \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;start&gt;</span> \<span class="variable">&lt;stop&gt;</span>  [WITHSCORES]**  </span><br><span class="line"></span><br><span class="line">  返回有序集 key 中，下标在\<span class="variable">&lt;start&gt;</span> \<span class="variable">&lt;stop&gt;</span>之间的元素</span><br><span class="line"></span><br><span class="line">  带WITHSCORES，可以让分数一起和值返回到结果集。</span><br><span class="line"></span><br><span class="line">- zrangebyscore key **<span class="keyword">min</span> <span class="keyword">max</span>** [withscores] [<span class="keyword">limit</span> offset count]</span><br><span class="line"></span><br><span class="line">  返回有序集 key 中，所有 score 值介于 <span class="keyword">min</span> 和 <span class="keyword">max</span> 之间(包括等于 <span class="keyword">min</span> 或 <span class="keyword">max</span> )的成员。有序集成员按 score 值递增(从小到大)次序排列。 </span><br><span class="line"></span><br><span class="line">- zrevrangebyscore key **<span class="keyword">max</span> <span class="keyword">min</span>** [withscores] [<span class="keyword">limit</span> offset count]        </span><br><span class="line"></span><br><span class="line">  同上，改为从大到小排列。 </span><br><span class="line"></span><br><span class="line">- zincrby \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;increment&gt;</span> \<span class="variable">&lt;value&gt;</span>    为元素的score加上增量</span><br><span class="line"></span><br><span class="line">- zrem  \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span>删除该集合下，指定值的元素 </span><br><span class="line"></span><br><span class="line">- zcount \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;min&gt;</span> \<span class="variable">&lt;max&gt;</span>统计该集合，分数区间内的元素个数 </span><br><span class="line"></span><br><span class="line">- zrank \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;value&gt;</span>返回该值在集合中的排名，从<span class="number">0</span>开始。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 数据结构</span></span><br><span class="line"></span><br><span class="line">zset 是一个redis提供的一个特别的数据结构，一方面等价于 Java 数据结构 map<span class="variable">&lt;String,Double&gt;</span>，可以给每个元素value 赋予一个权重score，另一方面又类似与TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，可以通过score的范围来获取元素的列表。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zset底层使用了俩个数据结构</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. hash，关联元素value和score，保障元素value的唯一性，可以通过value找到相应的score值</span><br><span class="line"><span class="number">2</span>. 跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**跳跃表结构**</span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210616112117821</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210616140956166</span>.png)</span><br><span class="line"></span><br><span class="line">如果找<span class="number">51</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 从第<span class="number">2</span>层找<span class="number">1</span>，<span class="number">21</span>.没找到到下一层</span><br><span class="line"><span class="number">2</span>. 第<span class="number">1</span>层，<span class="number">41</span>，<span class="number">61</span>，没找到。再下一层</span><br><span class="line"><span class="number">3</span>. 第<span class="number">0</span>层，<span class="number">51</span>。找到。共查找<span class="number">4</span>次</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3.Redis 发布和订阅</span></span><br><span class="line"></span><br><span class="line">类似于 Kafka的机制，一个发布者发布消息，订阅者接收消息</span><br><span class="line"></span><br><span class="line">Redis客户端可以订阅任意数量的频道。</span><br><span class="line"></span><br><span class="line">**客户端订阅频道**</span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210616140949389</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210616140949389</span>.png)</span><br><span class="line"></span><br><span class="line">**接收消息**</span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210616140956166</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210616112117821</span>.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 命令行实现</span></span><br><span class="line"></span><br><span class="line">**订阅**</span><br><span class="line"></span><br><span class="line">subscribe channel2</span><br><span class="line"></span><br><span class="line">**发布消息**</span><br><span class="line"></span><br><span class="line">publish channel2 <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">订阅chennel2的客户端就会接收到消息。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 注：发布的消息没有持久化，只能先订阅之后，才能收到后续的消息。之前的消息是收不到的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 4.Redis新数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.1Bitmaps</span></span><br><span class="line"></span><br><span class="line">一个key，带一串二进制码，可以设置<span class="number">0</span>/<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line">![image-<span class="number">20210616141854995</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210616141854995</span>.png)</span><br><span class="line"></span><br><span class="line">可以对每一个位置的设置<span class="number">0</span>/<span class="number">1</span>，使用偏移量表示每个位置。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 命令</span></span><br><span class="line"></span><br><span class="line">- setbit \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;offset&gt;</span> \<span class="variable">&lt;value&gt;</span>设置Bitmaps中某个偏移量的值（<span class="number">0</span>或<span class="number">1</span>）</span><br><span class="line"></span><br><span class="line">  <span class="built_in">set</span> bit user1 <span class="number">12</span> <span class="number">1</span>   设置key为<span class="keyword">user</span>，偏移量<span class="number">12</span>的位置为<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  &gt; 在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</span><br><span class="line"></span><br><span class="line">- getbit \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;offset&gt;</span>获取Bitmaps中某个偏移量的值</span><br><span class="line"></span><br><span class="line">- bitcount \<span class="variable">&lt;key&gt;</span> [start end]，<span class="number">0</span>是起始位置，-<span class="number">1</span>是结束位置，-<span class="number">2</span>倒数第二个</span><br><span class="line"></span><br><span class="line">  统计字符串中 start 到end 值为<span class="number">1</span>的个数</span><br><span class="line"></span><br><span class="line">- bitop and(or/not/xor) \<span class="variable">&lt;destkey&gt;</span> [key…]  </span><br><span class="line"></span><br><span class="line">  and交集，or并集，not非，xor异或。destkey是接收端，中括号里面的是进行and，or等操作的数据。符合的数据会保存在destkey中。例如以下交集</span><br><span class="line"></span><br><span class="line">  ![image-<span class="number">20210616143544007</span>](https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-<span class="number">20210628100626307</span>.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Bitmaps与set对比</span></span><br><span class="line"></span><br><span class="line">假设网站有<span class="number">1</span>亿用户， 每天独立访问的用户有<span class="number">5</span>千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表</span><br><span class="line"></span><br><span class="line">| <span class="built_in">set</span>和Bitmaps存储一天活跃用户对比 |                    |                  |                        |</span><br><span class="line">| -------------------------------- | ------------------ | ---------------- | ---------------------- |</span><br><span class="line">| 数据类型                         | 每个用户id占用空间 | 需要存储的用户量 | 全部内存量             |</span><br><span class="line">| 集合类型                         | <span class="number">64</span>位               | <span class="number">50000000</span>         | <span class="number">64</span>位*<span class="number">50000000</span> = <span class="number">400</span>MB  |</span><br><span class="line">| Bitmaps                          | <span class="number">1</span>位                | <span class="number">100000000</span>        | <span class="number">1</span>位*<span class="number">100000000</span> = <span class="number">12.5</span>MB |</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的</span><br><span class="line"></span><br><span class="line">| <span class="built_in">set</span>和Bitmaps存储独立用户空间对比 |        |        |       |</span><br><span class="line">| -------------------------------- | ------ | ------ | ----- |</span><br><span class="line">| 数据类型                         | 一天   | 一个月 | 一年  |</span><br><span class="line">| 集合类型                         | <span class="number">400</span>MB  | <span class="number">12</span>GB   | <span class="number">144</span>GB |</span><br><span class="line">| Bitmaps                          | <span class="number">12.5</span>MB | <span class="number">375</span>MB  | <span class="number">4.5</span>GB |</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有<span class="number">10</span>万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是<span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">| <span class="built_in">set</span>和Bitmaps存储一天活跃用户对比（独立用户比较少） |                    |                  |                        |</span><br><span class="line">| -------------------------------------------------- | ------------------ | ---------------- | ---------------------- |</span><br><span class="line">| 数据类型                                           | 每个userid占用空间 | 需要存储的用户量 | 全部内存量             |</span><br><span class="line">| 集合类型                                           | <span class="number">64</span>位               | <span class="number">100000</span>           | <span class="number">64</span>位*<span class="number">100000</span> = <span class="number">800</span>KB    |</span><br><span class="line">| Bitmaps                                            | <span class="number">1</span>位                | <span class="number">100000000</span>        | <span class="number">1</span>位*<span class="number">100000000</span> = <span class="number">12.5</span>MB |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.2 HyperLogLog</span></span><br><span class="line"></span><br><span class="line">解决基数问题。如同<span class="built_in">set</span>，hash，bitmaps等数据结构。不能有重复数据。但是HyperLogLog使用的内存更少。一般用于统计网站独立ip访问量。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">什么是基数?</span><br><span class="line"></span><br><span class="line">比如数据集 &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>&#125;， 那么这个数据集的基数集为 &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span> ,<span class="number">7</span>, <span class="number">8</span>&#125;, 基数(不重复元素)为<span class="number">5</span>。 基数估计就是在误差可接受的范围内，快速计算基数。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 命令</span></span><br><span class="line"></span><br><span class="line">- pfadd \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt; element&gt;</span> [element ...]  </span><br><span class="line"></span><br><span class="line">  pfadd k1 <span class="string">&quot;java&quot;</span></span><br><span class="line"></span><br><span class="line">- pfcount \<span class="variable">&lt;key&gt;</span> [key] 计算key里面有多少数量</span><br><span class="line"></span><br><span class="line">- pfmerge \<span class="variable">&lt;destkey&gt;</span> \<span class="variable">&lt;sourcekey&gt;</span> [sourcekey....]  将一个或多个key合并，将结果存到destkey中。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.3 Geospatial</span></span><br><span class="line"></span><br><span class="line">​	Redis <span class="number">3.2</span> 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的<span class="number">2</span>维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 命令</span></span><br><span class="line"></span><br><span class="line">- geoadd \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;longitude&gt;</span> \<span class="variable">&lt;latitude&gt;</span> \<span class="variable">&lt;member&gt;</span> [longitude latitude member.....]</span><br><span class="line"></span><br><span class="line">  添加地理位置  经度 纬度 名称，可添加多个</span><br><span class="line"></span><br><span class="line">  geoadd china:city  <span class="number">121</span>  <span class="number">90</span>  shanghai   </span><br><span class="line"></span><br><span class="line">  &gt; 注：两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。</span><br><span class="line">  &gt;</span><br><span class="line">  &gt; 有效的经度从 -<span class="number">180</span> 度到 <span class="number">180</span> 度。有效的纬度从 -<span class="number">85.05112878</span> 度到 <span class="number">85.05112878</span> 度。</span><br><span class="line"></span><br><span class="line">- geopos  \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;member&gt;</span> [member...]  获得指定地区的坐标值</span><br><span class="line"></span><br><span class="line">- geodist \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt;member1&gt;</span> \<span class="variable">&lt;member2&gt;</span>  [m|km|ft|mi ]  获取两个位置之间的直线距离</span><br><span class="line"></span><br><span class="line">  单位：</span><br><span class="line"></span><br><span class="line">  m 表示单位为米[默认值]。</span><br><span class="line"></span><br><span class="line">  km 表示单位为千米。</span><br><span class="line"></span><br><span class="line">  mi 表示单位为英里。</span><br><span class="line"></span><br><span class="line">  ft 表示单位为英尺。</span><br><span class="line"></span><br><span class="line">  如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</span><br><span class="line"></span><br><span class="line">- georadius \<span class="variable">&lt;key&gt;</span> \<span class="variable">&lt; longitude&gt;</span> \<span class="variable">&lt;latitude&gt;</span> radius m|km|ft|mi  以给定的经纬度为中心，找出某一半径内的元素</span><br><span class="line"></span><br><span class="line">  key 经度 纬度 半径 单位</span><br><span class="line"></span><br><span class="line">  georadius china:city <span class="number">110</span> <span class="number">30</span> <span class="number">100</span> km</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 5.Redis-Jedis</span></span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line"><span class="variable">&lt;dependency&gt;</span></span><br><span class="line">    <span class="variable">&lt;groupId&gt;</span>redis.clients&lt;/<span class="keyword">group</span>Id&gt;</span><br><span class="line">    <span class="variable">&lt;artifactId&gt;</span>jedis&lt;/artifactId&gt;</span><br><span class="line">    <span class="variable">&lt;version&gt;</span><span class="number">3.2</span>.<span class="number">0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>前置要求</strong></p>
<blockquote>
<p>关掉Linux防火墙或打开redis的端口</p>
<p>防火墙关闭</p>
<p>systemctl disable firewalld.service</p>
<p>配置redis.conf</p>
<p>将 bind 127.0.0.1注释</p>
<p>protected-mode yes改为no</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.yvenxx.test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">redis1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;192.168.1.6&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        String ping = jedis.ping();</span><br><span class="line">        System.out.println(ping);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>测试kv键值对</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;192.168.1.6&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    jedis.set(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    String k1 = jedis.get(<span class="string">&quot;k1&quot;</span>);</span><br><span class="line">    System.out.println(k1);</span><br><span class="line"></span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他功能查api</p>
<h2 id="6-Springboot整合Redis"><a href="#6-Springboot整合Redis" class="headerlink" title="6.Springboot整合Redis"></a>6.Springboot整合Redis</h2><h2 id="7-Redis事务-锁机制"><a href="#7-Redis事务-锁机制" class="headerlink" title="7.Redis事务_锁机制"></a>7.Redis事务_锁机制</h2><h3 id="7-1-事务定义"><a href="#7-1-事务定义" class="headerlink" title="7.1 事务定义"></a>7.1 事务定义</h3><p>​    Redis事务是一个单独的隔离操作，事务中的所有命令都会被序列化，按顺序执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>
<p>​    Redis事务的主要作用是<strong>串联多个命令</strong>防止别的命令插队。</p>
<h3 id="7-2-Multi，Exec，Discard"><a href="#7-2-Multi，Exec，Discard" class="headerlink" title="7.2 Multi，Exec，Discard"></a>7.2 Multi，Exec，Discard</h3><p>Multi开启事务，输入的命令依次进入命令队列中，不会执行，输入Exec之后，对前面的命令依次执行。</p>
<p>discard放弃组队。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210616143544007.png" alt="image-20210628100626307"></p>
<h3 id="7-3-事务冲突"><a href="#7-3-事务冲突" class="headerlink" title="7.3 事务冲突"></a>7.3 事务冲突</h3><p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628103538726.png" alt="image-20210628103538726"></p>
<h3 id="7-4-悲观锁"><a href="#7-4-悲观锁" class="headerlink" title="7.4 悲观锁"></a>7.4 悲观锁</h3><p>每次拿数据都认为别人会修改数据。所以每次都上锁。别人要拿到数据，除非他释放。传统数据库中很多这类锁机制。行锁，表锁，读锁，写锁。</p>
<h3 id="7-5-乐观锁"><a href="#7-5-乐观锁" class="headerlink" title="7.5 乐观锁"></a>7.5 乐观锁</h3><p>每次拿数据都认为别人不会修改，所以不会上锁。但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。利用版本号等机制。乐观锁适用于多读的应用类型，可以提高吞吐量。<strong>Redis就是利用这种check-and-set机制实现事务的。</strong></p>
<h3 id="7-6-WATCH-key-key-…"><a href="#7-6-WATCH-key-key-…" class="headerlink" title="7.6 WATCH key [key ….]"></a>7.6 WATCH key [key ….]</h3><p>执行multi之前，先执行 watch key1 [key2] 可以监视一个或多个key，<strong>如果在事务执行之前这些key被其他命令改动，那么事务将打断。</strong></p>
<p><strong>unwatch</strong>取消对key的监视。如果先执行了exec或discard命令。也不需要执行unwatch</p>
<h3 id="8-Redis事务三特性"><a href="#8-Redis事务三特性" class="headerlink" title="8 Redis事务三特性"></a>8 Redis事务三特性</h3><ol>
<li><p>单独的隔离操作</p>
<p>事务中的所有命令都会被序列化，按顺序执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断</p>
</li>
<li><p>没有隔离级别的概念</p>
<p>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</p>
</li>
<li><p>不保证原子性</p>
<p>事务中如果有一条命令执行失败，其后的命令任然会被执行，没有回滚</p>
</li>
</ol>
<h2 id="8-Redis持久化"><a href="#8-Redis持久化" class="headerlink" title="8 Redis持久化"></a>8 Redis持久化</h2><ul>
<li><p>RDB（Redis DataBase)</p>
</li>
<li><p>AOF （Append Of File)</p>
</li>
</ul>
<h3 id="1-RDB（Redis-DataBase）"><a href="#1-RDB（Redis-DataBase）" class="headerlink" title="1.RDB（Redis DataBase）"></a>1.RDB（Redis DataBase）</h3><p>在指定的<strong>时间间隔</strong>内将内存中的数据集<strong>快照</strong>写入磁盘，也就是Snapshot快照，他恢复时是将快照文件直接读进内存里</p>
<p><strong>备份执行</strong></p>
<p>Redis会单独创建（<strong>fork</strong>）一个子进程来进行持久化，<strong>会先将数据写入到一个临时文件。</strong>等持久化结束了，再用这个<strong>临时文件替换上次持久化好的文件。</strong></p>
<p>整个过程中，主进程不进行任何IO操作，确保了极高的性能，如果需要进行大规模数据的回复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。<strong>RDB缺点是最后一次进行持久化的数据可能丢失。</strong></p>
<h4 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h4><ul>
<li>Fork的作用是复制一个与当前进程<strong>一样的进程</strong>。新进程的所有数据（变量，环境变量，程序计数器等）数值都和原进程一致，但是 是一个全新的进程，并<strong>作为原进程的子进程</strong></li>
<li>在Linux中，fork（）会产生一个和父进程完全相同的进程，但子进程在此后，多会用exec调用，出于效率，Linux引入了<strong>“写时复制技术”</strong></li>
<li><strong>一般情况父进程和子进程会共用同一段物理内存</strong>，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</li>
</ul>
<h4 id="RDB持久化流程"><a href="#RDB持久化流程" class="headerlink" title="RDB持久化流程"></a>RDB持久化流程</h4><p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628121128446.png" alt="image-20210628121128446"></p>
<h4 id="持久化配置文件"><a href="#持久化配置文件" class="headerlink" title="持久化配置文件"></a>持久化配置文件</h4><p>redis.conf中配置文件名称，默认为dump.rdb</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dbfilename dump.dbp</span><br><span class="line"></span><br><span class="line"><span class="comment">#rdb 文件的保存位置</span></span><br><span class="line"><span class="keyword">dir </span><span class="string">&quot;/xxx/xx&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>配置文件中默认的快照配置</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628121425305.png" alt="image-20210628121425305"></p>
<p><strong>save / bgsave：</strong>save是同步进行操作，bgsave是异步进行保存操作</p>
<p>save [时间] [次数]   默认一分钟内改一万次，五分钟改了10次，或15分钟改了一次</p>
<p>stop-writes-on-bgsave-error  当redis无法写入磁盘时，直接关掉redis的写操作。推荐yes</p>
<p>rdbchecksum 检查完整性</p>
<p>在存储快照后，可以让redisCRC64算法来进行数据校验，推荐yes</p>
<h4 id="rdb的备份"><a href="#rdb的备份" class="headerlink" title="rdb的备份"></a>rdb的备份</h4><ol>
<li>通过 config get dir 查询rdb文件的位置</li>
<li>将 *.rdb的文件拷贝到别的地方</li>
<li>关闭redis-》把备份的文件拷贝到工作目录下</li>
<li>启动redis，备份的数据会自动加载</li>
</ol>
<p><strong>优势</strong></p>
<ul>
<li>适合大规模的数据恢复</li>
<li>对数据完整性和一致性要求不高更适合使用</li>
<li><strong>节省磁盘空间</strong></li>
<li><strong>恢复速度快</strong></li>
</ul>
<p><strong>劣势</strong></p>
<ul>
<li>Fork的时候，内存中的数据被克隆了一份，需要考虑2倍的膨胀性</li>
<li>虽然在fork时使用了 写拷贝技术，但是数据庞大消耗性能</li>
<li>redis意外宕机，会丢失最后一次快照的所有修改</li>
</ul>
<p><strong>停止RDB</strong></p>
<p>redis-cli config set save “”</p>
<p>表示禁用保存策略</p>
<h3 id="2-AOF"><a href="#2-AOF" class="headerlink" title="2.AOF"></a>2.AOF</h3><p>以日志的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来。只许追加文件但不可以改写文件，redis启动之处会读取该文件重新构建数据。换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次完成数据的恢复工作。</p>
<h4 id="AOF持久化流程"><a href="#AOF持久化流程" class="headerlink" title="AOF持久化流程"></a>AOF持久化流程</h4><ol>
<li>客户端的请求写命令会被append追加到AOF缓冲区内</li>
<li>AOF缓冲区根据AOF持久化策略 [always , everysec, no] 将操作sync同步到磁盘的AOF文件中</li>
<li>AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量</li>
<li>Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628165839312.png" alt="image-20210628165839312"></p>
<blockquote>
<p>AOF默认不开启</p>
<p>且AOF和RDB同时开启，系统默认读取AOF的数据，不会存在数据丢失</p>
</blockquote>
<h4 id="AOF-启动-修复-恢复"><a href="#AOF-启动-修复-恢复" class="headerlink" title="AOF 启动/修复/恢复"></a>AOF 启动/修复/恢复</h4><p>AOF备份和恢复操作与RDB一样，拷贝备份文件，需要恢复时拷贝到Redis工作目录下</p>
<ul>
<li><p>正常恢复</p>
<p>修改默认的 appendonly no改为yes</p>
<p>将有数据的aof文件复制到对应目录</p>
<p>重启redis</p>
</li>
<li><p>异常恢复</p>
<p>修改默认的 appendonly no 改为yes</p>
<p>遇到aof文件损坏，使用redis-check-aof –fix appendonly.aof进行恢复</p>
<p>备份被写坏的AOF文件</p>
<p>重启redis</p>
</li>
</ul>
<h4 id="AOF同步频率"><a href="#AOF同步频率" class="headerlink" title="AOF同步频率"></a>AOF同步频率</h4><p>appendonly [xxxx]</p>
<ul>
<li>always 始终同步，每次操作都会写入redis，性能差但数据完整性好</li>
<li>everysec 每秒同步，每秒记入日志一次，若宕机，本秒的数据可能丢失</li>
<li>no  不主动进行同步，把同步时机交给操作系统</li>
</ul>
<h4 id="Rewrite压缩"><a href="#Rewrite压缩" class="headerlink" title="Rewrite压缩"></a>Rewrite压缩</h4><p>AOF采用文件追加方式，文件会越来越大，为避免此情况，新增了重写机制，当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令bgrewriteaof</p>
<p>重写原理</p>
<p>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写（先写临时文件，最后rename）**redis4.0版本后的重写，是指吧rdb的快照以二进制的形式附加在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作</p>
<p>no-appendfsync-on-rewrite= yes/no</p>
<ul>
<li>yes时，不写入aof文件，只写入缓存，用户请求不会阻塞，但是在这段时间宕机会丢失这段时间的缓存数据（降低安全，提高性能）</li>
<li>no时，把数据写入磁盘里，但是遇到重写操作，可能会发生堵塞（数据安全，性能降低）</li>
</ul>
<p>重写时机</p>
<p>Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍，且文件大于64MB时触发</p>
<p>重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定负担的，因此设定Redis要满足一定条件才会重写</p>
<p>auto-aof-rewrite-percentage: 设置重写的基准值，文件达到100%时开始重写（文件是原来                                                        重写后文件的两倍）</p>
<p>auto-aof-rewrite-min-size: 设置重写的基准值，最小64MB，达到这个值开始重写</p>
<p>重写流程</p>
<ol>
<li>bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。</li>
<li>主进程fork出子进程执行重写操作，保证主进程不会阻塞</li>
<li>子进程遍历redis内存中数据，写到临时文件，客户端的写请求同时写入aof_buf缓冲区和aof_rewrite_buf 重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失</li>
<li>子进程写完新的 aof文件。向主进程发信号，父进程更新统计信息。主进程吧aof_rewrite_buf中的数据写入到新的AOF文件</li>
<li>使用新的AOF文件覆盖旧的AOF文件，完成AOF重写</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628185832538.png" alt="image-20210628173928884"></p>
<p><strong>优势</strong></p>
<ul>
<li><p>备份机制更稳健，丢失数据概率更低</p>
</li>
<li><p>可读的日志文件，通过日志处理误操作</p>
</li>
</ul>
<p><strong>劣势</strong></p>
<ul>
<li><p>比起RDB占用更多的磁盘空间</p>
</li>
<li><p>恢复备份速度要慢</p>
</li>
<li><p>每次读写都同步的话，有一定的性能压力</p>
</li>
<li><p>存在个别bug。</p>
</li>
</ul>
<h2 id="9-Redis-主从复制"><a href="#9-Redis-主从复制" class="headerlink" title="9 Redis 主从复制"></a>9 Redis 主从复制</h2><p>主机数据更新后根据配置和策略，自动同步到备机的master/slave机制，Master写为主，slave读为主</p>
<ul>
<li>读写分离，性能扩展</li>
<li>容灾快速恢复</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>拷贝多个redis.conf文件 include（写绝对路径）</p>
<p>开启 daemonize yes </p>
<p>pid文件名字 pidfile</p>
<p>指定端口 port</p>
<p>Log 文件名字</p>
<p>dump.rdb名字 dbfilename</p>
<p>appendonly 关掉或者换名字</p>
<p>slave-priority 10 优先级，值越小，优先级越高，用于选举主机时使用，默认100</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="regexp">/myredis/</span>redis.conf</span><br><span class="line">pidfile <span class="regexp">/var/</span>run/redis_6379.pid</span><br><span class="line">port <span class="number">6379</span></span><br><span class="line">dbfilename dump6379.rdb</span><br></pre></td></tr></table></figure>


<p><strong>多台就配置多个文件</strong></p>
<ol>
<li>启动几台机子</li>
<li>slaveof [ip] [port]   成为某个实例的从服务器</li>
<li>info replication 查看主从复制的相关信息</li>
</ol>
<blockquote>
<p>主机挂掉，重启就行</p>
<p>从机挂掉，重启，并重新运行  slaveof 命令才是从机。否则是单主机</p>
</blockquote>
<h3 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h3><p>后台监控主机是否故障，如果故障了根据投票自动将从库转换为主库</p>
<p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ul>
<li><strong>监控（Monitoring</strong>）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li><strong>提醒（Notification）</strong>： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li><strong>自动故障迁移（Automatic failover）</strong>： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li>
</ul>
<p>两种方式使用 sentinel</p>
<ol>
<li><p>对于 redis-sentinel 程序， 你可以用以下命令来启动 Sentinel 系统：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel <span class="regexp">/path/</span>to/sentinel.conf</span><br></pre></td></tr></table></figure></li>
<li><p>对于 redis-server 程序， 你可以用以下命令来启动一个运行在 Sentinel 模式下的 Redis 服务器：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="keyword">server</span> /<span class="type">path</span>/<span class="keyword">to</span>/sentinel.conf <span class="comment">--sentinel</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h4 id="sentinel配置文件"><a href="#sentinel配置文件" class="headerlink" title="sentinel配置文件"></a>sentinel配置文件</h4><p>运行一个 Sentinel 所需的最少配置如下所示：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sentinel<span class="built_in"> monitor </span>mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line">sentinel<span class="built_in"> monitor </span>resque 192.168.1.3 6380 4</span><br><span class="line">sentinel down-after-milliseconds resque 10000</span><br><span class="line">sentinel failover-timeout resque 180000</span><br><span class="line">sentinel parallel-syncs resque 5</span><br></pre></td></tr></table></figure>
<p>第一行配置，sentinel去监视 mymaster的主服务器。最后那个2，是如果要将这个服务器判断为失效至少需要2个Sentinel同意（只要同意sentinel的数量不达标，自动故障迁移就不会执行）</p>
<p>不过要注意， 无论你设置要多少个 Sentinel 同意才能判断一个服务器失效， 一个 Sentinel 都需要获得系统中多数（majority） Sentinel 的支持， 才能发起一次自动故障迁移， 并预留一个给定的配置纪元 （configuration Epoch ，一个配置纪元就是一个新主服务器配置的版本号）。</p>
<p>换句话说， 在只有少数（minority） Sentinel 进程正常运作的情况下， Sentinel 是不能执行自动故障迁移的。</p>
<p>其他选项的基本格式如下：</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel <span class="attribute">&lt;选项的名字&gt;</span> <span class="attribute">&lt;主服务器的名字&gt;</span> <span class="attribute">&lt;选项的值&gt;</span></span><br></pre></td></tr></table></figure>
<p>具体意思查 api</p>
<h4 id="故障恢复原则"><a href="#故障恢复原则" class="headerlink" title="故障恢复原则"></a>故障恢复原则</h4><p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628173928884.png" alt="image-20210628185832538"></p>
<p><strong>Java主从复制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JedisSentinelPool jedisSentinelPool=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getJedisFromSentinel</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(jedisSentinelPool==<span class="keyword">null</span>)&#123;</span><br><span class="line">        Set&lt;String&gt; sentinelSet=<span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        sentinelSet.add(<span class="string">&quot;192.168.11.103:26379&quot;</span>);</span><br><span class="line"></span><br><span class="line">        JedisPoolConfig jedisPoolConfig =<span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">10</span>); <span class="comment">//最大可用连接数</span></span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">5</span>); <span class="comment">//最大闲置连接数</span></span><br><span class="line">        jedisPoolConfig.setMinIdle(<span class="number">5</span>); <span class="comment">//最小闲置连接数</span></span><br><span class="line">        jedisPoolConfig.setBlockWhenExhausted(<span class="keyword">true</span>); <span class="comment">//连接耗尽是否等待</span></span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(<span class="number">2000</span>); <span class="comment">//等待时间</span></span><br><span class="line">        jedisPoolConfig.setTestOnBorrow(<span class="keyword">true</span>); <span class="comment">//取连接的时候进行一下测试 ping pong</span></span><br><span class="line"></span><br><span class="line">        jedisSentinelPool=<span class="keyword">new</span> JedisSentinelPool(<span class="string">&quot;mymaster&quot;</span>,sentinelSet,jedisPoolConfig);</span><br><span class="line">        <span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="10-Redis集群"><a href="#10-Redis集群" class="headerlink" title="10 Redis集群"></a>10 Redis集群</h2><p>集群实现了对Redis的水平扩容，启动N个借点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的 1/N</p>
<p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>
<h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h3><ol>
<li><p>将rdb aof文件都删除</p>
</li>
<li><p>制作六个实例，6379 - 6381   6389-6391</p>
</li>
<li><p>配置基本信息</p>
<p>daemonize yes</p>
<p>pid 文件名</p>
<p>端口</p>
<p>Log文件名</p>
<p>dump.rdb名</p>
<p>appendonly 关掉或换名字</p>
</li>
<li><p>redis cluster配置修改</p>
<p>cluster-enable yes   打开集群模式</p>
<p>cluster-config-file nodes-6379.conf    设定节点配置文件名</p>
<p>cluster-node-timeout 15000   设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</p>
</li>
</ol>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> /home/bigdata/redis.<span class="keyword">conf</span></span><br><span class="line">port 6379</span><br><span class="line">pidfile <span class="string">&quot;/var/run/redis_6379.pid&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;dump6379.rdb&quot;</span></span><br><span class="line"><span class="keyword">dir</span> <span class="string">&quot;/home/bigdata/redis_cluster&quot;</span></span><br><span class="line">logfile <span class="string">&quot;/home/bigdata/redis_cluster/redis_err_6379.log&quot;</span></span><br><span class="line"><span class="keyword">cluster</span>-enabled yes</span><br><span class="line"><span class="keyword">cluster</span>-config-<span class="keyword">file</span> nodes-6379.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">cluster</span>-node-timeout 15000</span><br></pre></td></tr></table></figure>
<p>配置六个这个文件   不同端口文件名记得修改</p>
<p><strong>启动六个redis服务，将六个节点合成一个集群</strong></p>
<p>组合之前确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常</p>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210629102146527.png" alt="image-20210628192753659"></p>
<p>组成集群</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在redis bin目录下</span><br><span class="line">redis-cli --cluster create --cluster-replicas <span class="number">1 192.168.1</span>.<span class="number">1:6379 192</span>.<span class="number">168.1.1</span>:<span class="number">6380 192.168</span>.<span class="number">1.1:6381</span> <span class="number">192.168.1.1</span>:<span class="number">6389 192.168</span>.<span class="number">1.1:6390</span> <span class="number">192.168.1.1</span>:<span class="number">6391</span> </span><br></pre></td></tr></table></figure>
<p>replicas 1   采用最简单的方式配置集群，一台主机，一台从机。组成三组</p>
<h3 id="登陆"><a href="#登陆" class="headerlink" title="登陆"></a>登陆</h3><p>普通方式登陆，可能直接进入读主机，会出现MOVED重定向操作。所以，应该以集群方式登陆。</p>
<p>集群方式登陆，加 -c，在设置数据时，会自动切换到相应的写主机。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">redis</span>-cli -c -p <span class="number">6379</span></span><br></pre></td></tr></table></figure>


<p><strong>通过cluster nodes 命令，查看集群信息</strong></p>
<h3 id="分配节点"><a href="#分配节点" class="headerlink" title="分配节点"></a><strong>分配节点</strong></h3><p>一个集群至少要<strong>三个主节点</strong>， –cluster-replicas 1 表示我们希望为集群中的每个主节点创建一个从节点。</p>
<p>分配原则：尽量保证每个主数据库运行在不同的 ip 地址，每个从库和主库不在一个 ip 地址上。</p>
<h3 id="slots"><a href="#slots" class="headerlink" title="slots"></a>slots</h3><p>一个Redis集群包含16384个插槽（hash slot），数据库的每个键都属于这16384个插槽的其中一个。</p>
<p>集群使用公式**CRC16(key) % 16384 来计算 key 属于哪个插槽，其中CRC16 语句用于计算key的CRC16校验和集群中的每个节点负责处理一部分插槽。</p>
<p>如</p>
<p>节点 A 负责处理 0 号至 5460 号插槽。</p>
<p>节点 B 负责处理 5461 号至 10922 号插槽。</p>
<p>节点 C 负责处理 10923 号至 16383 号插槽。</p>
<h3 id="集群录入值"><a href="#集群录入值" class="headerlink" title="集群录入值"></a>集群录入值</h3><p>redis-cli每次录入，查询键值，redis都会计算出该key应该送往的插槽，如果不是该服务器的插槽，redis会报错，并告知应当前往的redis实例地址和端口。</p>
<p>redis-cli客户端提供了 <strong>-c 参数实现自动重定向</strong>，<strong>不在一个slot下的键值，不能使用mset，mget等多键操作</strong>。但可以使用  {}，来定义组的概念，从而使key中 {} 内相同内容的键值对放到一个slot中去。</p>
<p><strong>查询集群中的值</strong></p>
<p>CLUSTER GETKEYSINSLOT [slot] [count]     返回count个slot槽中的键</p>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210629094110735.png" alt="image-20210629094110735"></p>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><ol>
<li>主从都挂掉，如果配置了 cluster-require-full-coverage为yes，那么整个集群挂掉</li>
<li>主从都挂掉，如果配置了，cluster-require-full-coverage为no，那么，该插槽数据全部不能使用，也无法存储。</li>
</ol>
<h3 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h3><p>即使链接的不是主机。也会自动切换到需要的主机和从机</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisClusterTest</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123; </span><br><span class="line">     Set&lt;HostAndPort&gt;<span class="built_in">set</span> =<span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();</span><br><span class="line">     <span class="built_in">set</span>.add(<span class="keyword">new</span> HostAndPort(<span class="string">&quot;192.168.31.211&quot;</span>,<span class="number">6379</span>));</span><br><span class="line">     JedisCluster jedisCluster=<span class="keyword">new</span> JedisCluster(<span class="built_in">set</span>);</span><br><span class="line">     jedisCluster.<span class="built_in">set</span>(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">     System.out.<span class="built_in">println</span>(jedisCluster.<span class="built_in">get</span>(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>优势</strong></p>
<p>实现扩容，分摊压力，无中心化配置相对简单</p>
<p><strong>劣势</strong></p>
<p>多键操作不被支持，lua不被支持。</p>
<h2 id="Redis-6新功能"><a href="#Redis-6新功能" class="headerlink" title="Redis 6新功能"></a>Redis 6新功能</h2><h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>Redis ACL是Access Control List（访问控制列表）的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接。</p>
<p>在Redis 5版本之前，Redis 安全规则只有密码控制 还有通过rename 来调整高危命令比如 flushdb ， KEYS* ， shutdown 等。</p>
<p>ACL功能对用户进行更细粒度的权限控制：</p>
<ol>
<li>接入权限：用户名和密码</li>
<li>可以执行的命令</li>
<li>可以操作的key</li>
</ol>
<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><ul>
<li><p>acl list 展现用户权限列表</p>
</li>
<li><p>acl cat 【string…..】 查看添加权限指令类别，加string或其他数据结构，可以查看具体的权限。</p>
</li>
<li><p>acl whoami 查看当前用户</p>
</li>
<li><p>acl setuser 创建和编辑用户。</p>
<p>acl setuser user1 on &gt;123456 ~a* +get</p>
<p>user1 密码 123456 可以get所有a开头的key</p>
</li>
<li><p>auth user password 切换用户</p>
</li>
</ul>
<h3 id="IO多线程"><a href="#IO多线程" class="headerlink" title="IO多线程"></a>IO多线程</h3><p>IO多线程指<strong>客户端交互部分</strong>的网络IO交互处理模块多线程，而非执行命令多线程。Redis执行线程依然是单线程</p>
<p>Redis多线程部分只是用来处理网络数据的读写和协议解析，执行命令任然是单线程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yvenxx/blog_img@main/images/image-20210628192753659.png" alt="image-20210629102146527"></p>
<p>默认不开启</p>
<p>配置</p>
<p>io-threads-do-reads yes</p>
<p>io-threads 4</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>Redis基础</p><p><span>文章作者：</span>懒人瑜恩</p><p><span>发布时间：</span>2021-12-05</p><p><span>最后更新：</span>2022-04-09</p><p><span>原始链接：</span><a href="/2021/Redis基础/">https://yvenxx.github.io/yvenxx/2021/Redis%E5%9F%BA%E7%A1%80/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://yvenxx.github.io/yvenxx/2021/Redis%E5%9F%BA%E7%A1%80/"></i></span></p><p><span>版权声明：</span>版权所有，转载请注明出处。</p></div><br><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://yvenxx.github.io/yvenxx/2021/Redis%E5%9F%BA%E7%A1%80/" data-id="cl1ra5bro0027ycu3cxntgwnb" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMklEQVR42u3aS27EIBBF0d7/pp1ppMj4viocNXAZRZaDOT0o1YfPB6/r1+LP//5992S827QlQ4aMZRnXcN19YHxQvvN4N76DDBkyTmDcHSL9zPgdEoL5DyRDhgwZ/Fjj4MjfIWAZMmTI4IXoOHTyI6YFsAwZMk5mkFBIDjQ3TL9Si8uQIWNBBu+6///fr8w3ZMiQsRTjChdv3KeNts6SIUPG3gwe4HgjbBym48Pxyx8yZMjYlNEPuGkqyamkITgtNZQhQ8YXM/qlLP/A+P1xytj/ugwZMtZl1ErKWUPNzs/0kNvKkCFjO0btn2vBl5es4+e3RawMGTK2ZvAxALlgQY44azcZMmTszeBFZppK8kK0/3UZMmScwBi343n4I++/EaBlyJBxAqN/xNqHyXWxOPeTIUPGdgyyUVxG4ssWnWFD8DEZMmQszkgHjSTtq7XzCGlCaihDhozFGWkTrTMqmBvcZciQsTeDbMeLzLQAnnUSGTJk7M3gV754akgCK38SY2TIkLEpIx0i9seQtVL2ASNDhoxjGDyY8sZ9nN7VEkoZMmQcwAga7jh95BPG2nAUTS1kyJCxOOMKV6cQTQNrcI1MhgwZWzNmDTX77bNa4y/GyJAhY1lGLcjW7jx0hpcP41IZMmQcwJgbv9PrX2kRi26OyJAh43gGH0mm44fiOEGGDBky2q2u2viTpI8yZMg4h9G/+NVp0pEgO63dJkOGjAUZrZsaOBynqV461JQhQ8amjB9UTRkGwGvl7AAAAABJRU5ErkJggg==">分享</a><div class="tags"></div><div class="post-nav"><a class="pre" href="/2021/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/">数据库原理</a><a class="next" href="/2021/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0/">操作系统 第五章</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'N4VbzTDUCqw4JIrXrqmTYp1b-gzGzoHsz',
  appKey:'1sOcwRIiKguk8n88JwbgSrCV',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://yvenxx.github.io/yvenxx"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%94%BF%E6%B2%BB/">政治</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/%E5%BE%90%E6%B6%9B-%E5%9F%BA%E7%A1%80%E7%8F%AD-%E6%80%9D%E4%BF%AE%E6%B3%95%E5%9F%BA/">徐涛-基础班-思修法基</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/%E5%BE%90%E6%B6%9B-%E5%9F%BA%E7%A1%80%E7%8F%AD-%E5%8F%B2%E7%BA%B2/">徐涛-基础班-史纲</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/%E5%BE%90%E6%B6%9B-%E5%9F%BA%E7%A1%80%E7%8F%AD-%E6%AF%9B%E4%B8%AD%E7%89%B9/">徐涛-基础班-毛中特</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/%E5%BE%90%E6%B6%9B-%E5%9F%BA%E7%A1%80%E7%8F%AD-%E9%A9%AC%E5%8E%9F/">徐涛-基础班-马原</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86/">数据库原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/Redis%E5%9F%BA%E7%A1%80/">Redis基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0/">操作系统 第五章</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E5%9B%9B%E7%AB%A0/">操作系统 第四章</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%B8%89%E7%AB%A0/">操作系统-第三章</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%8C%E7%AB%A0/">操作系统-第二章</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.yvenxx.cn/" title="懒人瑜恩" target="_blank">懒人瑜恩</a><ul></ul><a href="https://wjjhui.github.io/" title="兔哦鸡" target="_blank">兔哦鸡</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">懒人瑜恩.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>